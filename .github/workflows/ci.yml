name: CI

on:
  push:
    branches: ['**']
    tags: ['*']
  pull_request:

jobs:
  init:
    name: "Init step"
    runs-on: ubuntu-latest
    outputs:
      docker_files: ${{ steps.collect_docker.outputs.docker_files }}
      module_dirs: ${{ steps.collect_docker.outputs.module_dirs }}
      modules_for_tests: ${{ steps.collect_modules_tests.outputs.modules_for_tests }}

    steps:
      - uses: actions/checkout@v4
      - name: Collect Dockerfiles and module directories to build
        id: collect_docker
        run: |
          files=$(git ls-files '*/Dockerfile')
          if [ -z "$files" ]; then
            echo "docker_files=[]" >> "$GITHUB_OUTPUT"
            echo "module_dirs=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          docker_files=$(printf '%s\n' "$files" | jq -R -s -c 'split("\n")[:-1]')
          module_dirs=$(printf '%s\n' "$files" | xargs -n1 dirname | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "docker_files=$docker_files" >> "$GITHUB_OUTPUT"
          echo "module_dirs=$module_dirs" >> "$GITHUB_OUTPUT"
      - name: Init modules for Tests
        id: collect_modules_tests
        run: |
          modules_for_tests='["api-gateway","frontend"]'
          echo "modules_for_tests=$modules_for_tests" >> "$GITHUB_OUTPUT"

  tests:
    name: Run Unit Tests
    needs: init
    runs-on: ubuntu-latest
    if: ${{ needs.init.outputs.modules_for_tests != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.init.outputs.modules_for_tests) }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ matrix.module }}
          sparse-checkout-cone-mode: false
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.module }}/package-lock.json
      - name: Install
        run: npm ci
        working-directory: ${{ matrix.module }}
      - name: Run unit tests
        run: npm run test:unit
        working-directory: ${{ matrix.module }}

  validate:
    name: Validate files
    runs-on: ubuntu-latest
    needs: init
    if: ${{ needs.init.outputs.docker_files != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJson(needs.init.outputs.docker_files) }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ matrix.dockerfile }}
          sparse-checkout-cone-mode: false
      - name: Lint Dockerfile
        run: docker run --rm -i hadolint/hadolint hadolint --failure-threshold error - < "${{ matrix.dockerfile }}"

  build:
    name: Build Images
    runs-on: ubuntu-latest
    needs: [init, tests, validate]
    #if: ${{ startsWith(github.ref, 'refs/tags/') && needs.init.outputs.module_dirs != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.init.outputs.module_dirs) }}
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        env:
          REGISTRY_URL: ${{ secrets.SECRET_GITHUB_REGISTRY_URL }}
        run: |
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          safe_dir="${{ matrix.dir }}"
          safe_dir="${safe_dir//\//-}"
          image_name="${REGISTRY_URL}/final-project-${safe_dir}"
          echo "Building image for ${image_name}:${image_tag}"
          docker build -t "${image_name}:${image_tag}" -f "${{ matrix.dir }}/Dockerfile" "${{ matrix.dir }}"
      - name: Push images
        env:
          REGISTRY_URL: ${{ secrets.SECRET_GITHUB_REGISTRY_URL }}
          REGISTRY_USERNAME: ${{ secrets.SECRET_GITHUB_REGISTRY_USERNAME }}
          REGISTRY_TOKEN: ${{ secrets.SECRET_GITHUB_REGISTRY_TOKEN }}
        run: |
          echo "$REGISTRY_TOKEN" | docker login "$REGISTRY_URL" -u "$REGISTRY_USERNAME" --password-stdin
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          safe_dir="${{ matrix.dir }}"
          safe_dir="${safe_dir//\//-}"
          image_name="${REGISTRY_URL}/final-project-${safe_dir}"
          echo "Pushing image ${image_name}:${image_tag}"
          docker push "${image_name}:${image_tag}"

  smoke_test:
    name: Smoke Test Images
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Smoke test images
        env:
          REGISTRY_URL: ${{ secrets.SECRET_GITHUB_REGISTRY_URL }}
        run: |
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          export REGISTRY_URL IMAGE_TAG="$image_tag"
          chmod +x scripts/ci_smoke.sh
          docker compose -f docker-compose.ci.yml up -d --pull=always
          ./scripts/ci_smoke.sh
          docker compose -f docker-compose.ci.yml down -v

  update_helm:
    name: Update Helm appVersion
    runs-on: ubuntu-latest
    needs: smoke_test
    steps:
      - name: Checkout helm repo
        uses: actions/checkout@v4
        with:
          repository: romastelchenko/it-academy.00.final-project-helm
          token: ${{ secrets.SECRET_GITHUB_HELM_REPO_TOKEN }}
      - name: Setup Helm
        uses: azure/setup-helm@v4
      - name: Update Chart.yaml appVersion
        run: |
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          chart_dir="helm-sources/football-app"
          if [ ! -f "${chart_dir}/Chart.yaml" ]; then
            echo "Chart.yaml not found"
            exit 1
          fi
          sed -i -E "s/^appVersion:.*/appVersion: \"${image_tag}\"/" "${chart_dir}/Chart.yaml"
          current_version=$(grep -E '^version:' "${chart_dir}/Chart.yaml" | awk '{print $2}' | tr -d '"')
          IFS='.' read -r major minor patch <<< "$current_version"
          patch=$((patch + 1))
          chart_version="${major}.${minor}.${patch}"
          sed -i -E "s/^version:.*/version: \"${chart_version}\"/" "${chart_dir}/Chart.yaml"
          echo "Updated appVersion to ${image_tag}"
          echo "Updated version to ${chart_version}"
      - name: Package chart and update index
        run: |
          chart_dir="helm-sources/football-app"
          releases_dir="helm-releases"
          repo_url="https://romastelchenko.github.io/it-academy.00.final-project-helm/helm-releases"
          mkdir -p "${releases_dir}"
          helm package "${chart_dir}" -d "${releases_dir}"
          if [ -f "${releases_dir}/index.yaml" ]; then
            helm repo index "${releases_dir}" --url "${repo_url}" --merge "${releases_dir}/index.yaml"
          else
            helm repo index "${releases_dir}" --url "${repo_url}"
          fi
      - name: Commit and push
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.email "github-actions@users.noreply.github.com"
          git config user.name "github-actions"
          git add helm-sources/football-app/Chart.yaml helm-releases/index.yaml helm-releases/*.tgz
          git commit -m "chore: bump appVersion to ${GITHUB_REF_NAME}-$(date +'%d%m%y')"
          git push

  notify_with_results:
    runs-on: ubuntu-latest
    needs: [init, tests, validate, build, smoke_test, update_helm]
    if: always()
    steps:

      - name: Send slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECRET_SLACK_WEBHOOK_URL }}
          TESTS_RESULT: ${{ needs.tests.result }}
          VALIDATION_RESULT: ${{ needs.validate.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          SMOKE_RESULT: ${{ needs.smoke_test.result }}
          HELM_RESULT: ${{ needs.update_helm.result }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          message="CI results for ${GITHUB_REPOSITORY} @ ${GITHUB_REF_NAME}\n"
          message+="Run: ${RUN_URL}\n"
          message+="Tests: ${TESTS_RESULT}\n"
          message+="Validation: ${VALIDATION_RESULT}\n"
          message+="Build: ${BUILD_RESULT}\n"
          message+="Smoke: ${SMOKE_RESULT}\n"
          message+="Helm: ${HELM_RESULT}"
          message_body_pattern='{"text":"%s"}'
          message_body=$(printf "${message_body_pattern}" "${message}")
          curl -X POST -H 'Content-type: application/json' --data "${message_body}" ${SLACK_WEBHOOK_URL}
