name: CI

on:
  push:
    branches: ['**']
    tags: ['*']
  pull_request:

jobs:
  init:
    name: "Init step"
    runs-on: ubuntu-latest
    outputs:
      docker_files: ${{ steps.collect_docker.outputs.docker_files }}
      module_dirs: ${{ steps.collect_docker.outputs.module_dirs }}
      modules_for_tests: ${{ steps.collect_modules_tests.outputs.modules_for_tests }}

    steps:
      - uses: actions/checkout@v4
      - name: Collect Dockerfiles and module directories to build
        id: collect_docker
        run: |
          files=$(git ls-files '*/Dockerfile')
          if [ -z "$files" ]; then
            echo "docker_files=[]" >> "$GITHUB_OUTPUT"
            echo "module_dirs=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          docker_files=$(printf '%s\n' "$files" | jq -R -s -c 'split("\n")[:-1]')
          module_dirs=$(printf '%s\n' "$files" | xargs -n1 dirname | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "docker_files=$docker_files" >> "$GITHUB_OUTPUT"
          echo "module_dirs=$module_dirs" >> "$GITHUB_OUTPUT"
      - name: Init modules for Tests
        id: collect_modules_tests
        run: |
          modules_for_tests='["api-gateway","frontend"]'
          echo "modules_for_tests=$modules_for_tests" >> "$GITHUB_OUTPUT"

  tests:
    name: Run Unit Tests
    needs: init
    runs-on: ubuntu-latest
    if: ${{ needs.init.outputs.modules_for_tests != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.init.outputs.modules_for_tests) }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ matrix.module }}
          sparse-checkout-cone-mode: false
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.module }}/package-lock.json
      - name: Install
        run: npm ci
        working-directory: ${{ matrix.module }}
      - name: Run unit tests
        run: npm run test:unit
        working-directory: ${{ matrix.module }}

  validate:
    name: Validate files
    runs-on: ubuntu-latest
    needs: init
    if: ${{ needs.init.outputs.docker_files != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJson(needs.init.outputs.docker_files) }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ matrix.dockerfile }}
          sparse-checkout-cone-mode: false
      - name: Lint Dockerfile
        run: docker run --rm -i hadolint/hadolint hadolint --failure-threshold error - < "${{ matrix.dockerfile }}"

  build:
    name: Build Images
    runs-on: ubuntu-latest
    needs: init
    #if: ${{ startsWith(github.ref, 'refs/tags/') && needs.init.outputs.module_dirs != '[]' }}
    steps:
      - uses: actions/checkout@v4
      - name: Build all images
        env:
          MODULE_DIRS: ${{ needs.init.outputs.module_dirs }}
          REGISTRY_URL: ${{ secrets.SECRET_GITHUB_REGISTRY_URL }}
        run: |
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          echo "$MODULE_DIRS" | jq -r '.[]' | while read -r dir; do
            safe_dir="${dir//\//-}"
            image_name="${REGISTRY_URL}/final-project-${safe_dir}"
            echo "Building image for ${image_name}:${image_tag}"
            docker build -t "${image_name}:${image_tag}" -f "${dir}/Dockerfile" "${dir}"
          done
      - name: Smoke test images
        env:
          REGISTRY_URL: ${{ secrets.SECRET_GITHUB_REGISTRY_URL }}
        run: |
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          export REGISTRY_URL IMAGE_TAG="$image_tag"
          chmod +x scripts/ci_smoke.sh
          docker compose -f docker-compose.ci.yml up -d --pull=never
          ./scripts/ci_smoke.sh
          docker compose -f docker-compose.ci.yml down -v
      - name: Push images
        env:
          MODULE_DIRS: ${{ needs.init.outputs.module_dirs }}
          REGISTRY_URL: ${{ secrets.SECRET_GITHUB_REGISTRY_URL }}
          REGISTRY_USERNAME: ${{ secrets.SECRET_GITHUB_REGISTRY_USERNAME }}
          REGISTRY_TOKEN: ${{ secrets.SECRET_GITHUB_REGISTRY_TOKEN }}
        run: |
          echo "$REGISTRY_TOKEN" | docker login "$REGISTRY_URL" -u "$REGISTRY_USERNAME" --password-stdin
          tag_name="${GITHUB_REF_NAME}"
          tag_name="test"
          tag_date="$(date +'%d%m%y')"
          image_tag="${tag_name}-${tag_date}"
          echo "$MODULE_DIRS" | jq -r '.[]' | while read -r dir; do
            safe_dir="${dir//\//-}"
            image_name="${REGISTRY_URL}/final-project-${safe_dir}"
            echo "Pushing image ${image_name}:${image_tag}"
            docker push "${image_name}:${image_tag}"
          done

  notify_with_results:
    runs-on: ubuntu-latest
    needs: [init, tests, validate, build]
    if: always()
    steps:

      - name: Send slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECRET_SLACK_WEBHOOK_URL }}
          TESTS_RESULT: ${{ needs.tests.result }}
          VALIDATION_RESULT: ${{ needs.validate.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          message="CI results for ${GITHUB_REPOSITORY} @ ${GITHUB_REF_NAME}\n"
          message+="Run: ${RUN_URL}\n"
          message+="Tests: ${TESTS_RESULT}\n"
          message+="Validation: ${VALIDATION_RESULT}\n"
          message+="Build: ${BUILD_RESULT}"
          message_body_pattern='{"text":"%s"}'
          message_body=$(printf "${message_body_pattern}" "${message}")
          curl -X POST -H 'Content-type: application/json' --data "${message_body}" ${SLACK_WEBHOOK_URL}

